<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <title>Traffic Dashboard</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      min-height: 100vh;
    }

    .main-button {
      padding: 20px 40px;
      font-size: 24px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      text-decoration: none;
      margin: 30px 0;
    }

    .filter-box {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 90%;
      max-width: 600px;
    }

    select,
    input[type="datetime-local"] {
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      width: 100%;
    }

    .submit-button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .results {
      margin-top: 30px;
      width: 100%;
      max-width: 600px;
    }

    .summary-cards {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      flex: 1 1 48%;
      background-color: #007bff;
      color: white;
      padding: 16px;
      border-radius: 10px;
      font-size: 18px;
    }

    .card.green {
      background-color: #28a745;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid #ccc;
    }

    th {
      background-color: #f2f2f2;
    }
  </style>
</head>

<body>

  <a href="/viewer" class="main-button">Launch Visualization</a>

  <div class="filter-box">
    <h3>Check Overall Traffic Statistics</h3>
    <form id="filter-form">
      <label>Start Time</label>
      <input type="datetime-local" id="datetime_start" name="datetime_start" required>

      <label>End Time</label>
      <input type="datetime-local" id="datetime_end" name="datetime_end" required>

      <label>Detection Group (optional)</label>
      <select id="detection_group" name="detection_group">
        <option value="">-- All --</option>
        <option value="Hugh L. Carey Tunnel">Hugh L. Carey Tunnel</option>
        <option value="Queens Midtown Tunnel">Queens Midtown Tunnel</option>
      </select>

      <label>Vehicle Class (optional)</label>
      <select id="vehicle_class" name="vehicle_class">
        <option value="">-- All --</option>
        <option value="Car">Car</option>
        <option value="Truck">Truck</option>
        <option value="Bus">Bus</option>
      </select>

      <button class="submit-button" type="submit">Get Stats</button>
    </form>
  </div>

  <div class="results" id="results"></div>

  <script>
    document.getElementById("filter-form").addEventListener("submit", function (e) {
      e.preventDefault();

      const rawStart = document.getElementById("datetime_start").value;
      const rawEnd = document.getElementById("datetime_end").value;
      const detection_group = document.getElementById("detection_group").value;
      const vehicle_class = document.getElementById("vehicle_class").value;

      const datetime_start = rawStart.replace("T", " ") + ":00";
      const datetime_end = rawEnd.replace("T", " ") + ":00";

      const params = new URLSearchParams({ datetime_start, datetime_end });
      if (detection_group) params.append("detection_group", detection_group);
      if (vehicle_class) params.append("vehicle_class", vehicle_class);

      fetch(`/filter?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          const resultDiv = document.getElementById("results");

          // Vehicle summary output (you can keep this unchanged)
          resultDiv.innerHTML = `
    <div class="summary-cards">
      <div class="card">
        <strong>Total Vehicles:</strong><br>
        ${data.total_vehicles.toLocaleString()}
      </div>
      <div class="card green">
        <strong>Total Revenue:</strong><br>
        $${data.total_revenue.toLocaleString(undefined, { minimumFractionDigits: 2 })}
      </div>
    </div>
  `;

          // Prepare data for Sankey chart
          const sankeyDataArray = [
            ['From', 'To', 'Value']
          ];
          for (const [vehicleClass, count] of Object.entries(data.vehicle_counts)) {
  sankeyDataArray.push(['Total Vehicles', vehicleClass, count]);
}

for (const [vehicleClass, revenue] of Object.entries(data.revenue_per_class)) {
  sankeyDataArray.push(['Total Revenue', vehicleClass, revenue]);
}

          // Load Google Charts
          google.charts.load('current', { packages: ['sankey'] });
          google.charts.setOnLoadCallback(drawChart);

          function drawChart() {
            const chartData = google.visualization.arrayToDataTable(sankeyDataArray);

            const options = {
              width: '100%',
              height: 500,
              sankey: {
                node: {
                  label: { fontSize: 14 },
                },
                link: {
                  colorMode: 'gradient',
                  colors: ['#76a7fa', '#a2d4ab'],
                }
              }
            };

            const chart = new google.visualization.Sankey(document.getElementById('sankey_chart'));
            chart.draw(chartData, options);
          }


          resultDiv.innerHTML = `
            <div id="sankey_chart" style="width: 100%; height: 500px;"></div>
            <div class="summary-cards">
              <div class="card">
                <strong>Total Vehicles:</strong><br>
                ${data.total_vehicles.toLocaleString()}
              </div>
              <div class="card green">
                <strong>Total Revenue:</strong><br>
                $${data.total_revenue.toLocaleString(undefined, { minimumFractionDigits: 2 })}
              </div>
            </div>

            <div>
              <h4>Vehicle Counts</h4>
              <table>
                <thead>
                  <tr><th>Class</th><th>Count</th></tr>
                </thead>
                <tbody>
                  ${Object.entries(data.vehicle_counts).map(([key, val]) => `
                    <tr><td>${key}</td><td>${val.toLocaleString()}</td></tr>
                  `).join('')}
                </tbody>
              </table>
            </div>

            <div>
              <h4>Revenue by Class</h4>
              <table>
                <thead>
                  <tr><th>Class</th><th>Revenue</th></tr>
                </thead>
                <tbody>
                  ${Object.entries(data.revenue_per_class).map(([key, val]) => `
                    <tr><td>${key}</td><td>$${val.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td></tr>
                  `).join('')}
                </tbody>
              </table>
            </div>

          `;
        })
        .catch(error => {
          document.getElementById("results").innerText = "Error fetching data.";
          console.error(error);
        });
    });
  </script>
</body>

</html>